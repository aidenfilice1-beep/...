<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Parkour Runner - Extreme Skin Shop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* General styling for the page */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a2e; /* Dark theme background */
            font-family: 'Inter', sans-serif;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Canvas should take up the primary viewing area */
        #game-container {
            width: 100vw;
            height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        canvas {
            display: block;
            outline: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
        }

        /* Control panel styling */
        #controls {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 8px 8px 0 0;
            z-index: 10;
            text-align: center;
            font-size: 14px;
        }

        .control-key {
            display: inline-block;
            background-color: #4e455e;
            color: #ffffff;
            padding: 4px 8px;
            margin: 0 2px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        h1 {
            color: #ff9900;
            margin-bottom: 5px;
            font-size: 1.5rem;
        }

        .info-text {
            margin-top: 5px;
            color: #cccccc;
        }
        
        #level-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff7f;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 5px 10px;
            border-radius: 8px;
            z-index: 10;
        }

        /* Coin display styling (Top Right, "Pretty Big") */
        #coin-display {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2.0rem;
            font-weight: bold;
            color: #ffd700; /* Gold color for coins */
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 12px;
            z-index: 10;
            min-width: 150px;
            text-align: center;
            border: 2px solid #ffcc00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        /* Shop Button (Moved to Bottom Left) */
        #shop-button {
            position: absolute;
            bottom: 10px; 
            left: 10px; 
            z-index: 10;
        }

        #open-shop-btn {
            background-color: #ff9900;
            color: #1a1a2e;
            padding: 8px 15px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s;
        }

        #open-shop-btn:hover {
            background-color: #ffaa33;
        }

        /* Shop Modal */
        #shop-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        #shop-content-container {
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            background: #2b2b40;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            overflow-y: auto;
            border: 3px solid #ffcc00;
        }

        #shop-title {
            color: #ffd700;
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        
        /* Rarity Styles */
        .rarity-Common { color: #cccccc; }
        .rarity-Uncommon { color: #00ccff; }
        .rarity-Rare { color: #ff33cc; }
        .rarity-Epic { color: #9933ff; }
        .rarity-Legendary { color: #ff9900; }
        .rarity-Mythic { color: #ff0000; }
        
        .skin-card {
            background: #4e455e;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.1s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        
        .skin-card.selected {
            border-color: #00ff7f; /* Green highlight for selected pet */
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.8);
        }

        .skin-card:hover:not(.selected) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .skin-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
            white-space: nowrap; /* Prevent name wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .skin-rarity {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 3px;
        }

        .skin-icon {
            font-size: 3em;
            margin: 10px 0;
            display: block;
        }
        
        .skin-desc {
            font-size: 0.8em;
            color: #ccc;
            margin-bottom: 10px;
            min-height: 40px; /* Ensure consistent card height */
        }

        .skin-price {
            color: #ffd700;
            font-size: 1.0em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .skin-multiplier {
            color: #00ff7f;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .buy-button {
            background-color: #00ff7f;
            color: #1a1a2e;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
            width: 90%;
        }

        .buy-button:hover:not(:disabled) {
            background-color: #33ff99;
        }

        .equipped-label {
            background-color: #007f3f; 
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-top: 10px;
            display: inline-block;
        }

        #close-shop-btn {
            background-color: #ff0055;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            margin-top: 20px;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #close-shop-btn:hover {
            background-color: #cc0044;
        }
        
        #skin-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            padding-bottom: 20px;
        }


        /* Message box for game status/pause */
        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(43, 43, 64, 0.9);
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            z-index: 20;
            transition: opacity 0.3s ease;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .message-title {
            font-size: 2em;
            color: #ff9900; /* Orange for pause/start */
        }
        .message-subtitle {
            font-size: 1.2em;
            color: #e0e0ff;
            margin-top: 10px;
        }
        
        .win-color {
             color: #00ff7f !important; /* Bright green for win */
        }
        
    </style>
</head>
<body>

    <div id="game-container">
        <div id="level-display">Level 0</div>
        <!-- Shop Button GUI -->
        <div id="shop-button">
            <button id="open-shop-btn">ðŸŽ¨ Skins Shop (<span class="control-key" style="margin: 0;">E</span>)</button>
        </div>
        <!-- Coin Display GUI -->
        <div id="coin-display">ðŸ’° 0</div>
        
        <!-- Shop Modal -->
        <div id="shop-modal" class="hidden">
            <div id="shop-content-container">
                <h2 id="shop-title">The Grand Parkour Skin Emporium (104 Items)</h2>
                <div id="skin-list-container">
                    <!-- Skin cards will be rendered here by JavaScript -->
                </div>
                <!-- Button to close the shop (can also be closed with E or ESC) -->
                <button id="close-shop-btn">Close Shop</button>
            </div>
        </div>

        <!-- Three.js renderer attaches here -->
        <div id="controls">
            <div class="info-text">
                Movement: <span class="control-key">W</span> <span class="control-key">A</span> <span class="control-key">S</span> <span class="control-key">D</span> | Jump: <span class="control-key">SPACE</span> | Shop: <span class="control-key">E</span> | Pause: <span class="control-key">ESC</span>
                <br>Goal: Reach the <strong style="color: #ffff00;">Yellow Flag</strong> on the final platform!
            </div>
        </div>

        <div id="message-box">
            <div class="message-title">Click to Start</div>
            <div class="message-subtitle">Click anywhere on the screen to lock the mouse and begin. Press ESC to pause.</div>
        </div>

    </div>

    <script>
        // --- Game Setup Variables ---
        let scene, camera, renderer;
        let player, playerVelocity = new THREE.Vector3(0, 0, 0);
        let playerMesh = null; // The visible geometry of the player (sphere/box)
        const PLAYER_SCALE = 0.3; // Base radius/half-size for player mesh
        let moveSpeed = 0.15;
        let jumpPower = 0.3;
        const GRAVITY = 0.015;
        let keys = {};
        let platforms = [];
        let finishLine;
        let finishFlag; 
        const PLAYER_RADIUS = 0.3; 
        let levelCounter = 0; 
        
        // --- COIN SYSTEM VARIABLES ---
        let coinCount = 0;
        const LEVEL_REWARD = 10;
        // -----------------------------
        
        // --- PLAYER SKIN DATA (104 Skins) ---
        const SKINS = [
            // --- ORIGINAL COMMON SKINS (Price 0-50, Multiplier 1.0 - 1.2) ---
            { id: 'skin_001', name: 'Basic Runner', icon: 'ðŸ”´', price: 0, color: 0xff0000, rarity: 'Common', shape: 'sphere', multiplier: 1.0, description: 'The standard issue parkour unit.', features: 'none' },
            { id: 'skin_002', name: 'Aqua Prism', icon: 'ðŸ’Ž', price: 50, color: 0x00ffff, rarity: 'Common', shape: 'box', multiplier: 1.2, description: 'Grants clarity and stability (high visibility).', features: 'particles' },
            
            // --- ORIGINAL UNCOMMON/RARE/EPIC SKINS (Adjusted to fit new scheme) ---
            { id: 'skin_003', name: 'Golden Orb', icon: 'âœ¨', price: 150, color: 0xffd700, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Radiant and slightly magnetic.', features: 'pulsate' },
            { id: 'skin_004', name: 'Void Ghost', icon: 'ðŸ‘»', price: 400, color: 0x9370db, rarity: 'Rare', shape: 'sphere', multiplier: 1.8, description: 'A phantom of the speedway. (New Multiplier)', features: 'transparency' },
            
            // --- NEW UNCOMMON SKINS (x1.3 - x1.5, Price 100 - 300) ---
            { id: 'skin_005', name: 'Lime Zest', icon: 'ðŸŽ¾', price: 100, color: 0xccff00, rarity: 'Uncommon', shape: 'box', multiplier: 1.3, description: 'A sharp, acidic cube for those who like to stand out.', features: 'none' },
            { id: 'skin_006', name: 'Hot Pink', icon: 'ðŸŒ¸', price: 120, color: 0xff69b4, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.3, description: 'Impossible to ignore, blazing fast color.', features: 'none' },
            { id: 'skin_007', name: 'Desert Sand', icon: 'ðŸœï¸', price: 130, color: 0xedc9af, rarity: 'Uncommon', shape: 'box', multiplier: 1.3, description: 'A tough, dusty traveler.', features: 'none' },
            { id: 'skin_008', name: 'Forest Moss', icon: 'ðŸŒ¿', price: 140, color: 0x7c947c, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.3, description: 'Blends in, but reliable.', features: 'none' },
            { id: 'skin_009', name: 'Orange Peel', icon: 'ðŸŠ', price: 160, color: 0xffa500, rarity: 'Uncommon', shape: 'box', multiplier: 1.4, description: 'Simple, citrusy, and zippy.', features: 'none' },
            { id: 'skin_010', name: 'Electric Blue', icon: 'âš¡', price: 170, color: 0x1f00ff, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.4, description: 'A basic bolt of energy.', features: 'none' },
            { id: 'skin_011', name: 'Silver Dime', icon: 'âšª', price: 180, color: 0xc0c0c0, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.4, description: 'A simple coin, shiny and standard.', features: 'none' },
            { id: 'skin_012', name: 'Bronze Age', icon: 'ðŸ¥‰', price: 190, color: 0xcd7f32, rarity: 'Uncommon', shape: 'box', multiplier: 1.4, description: 'Tarnished but enduring.', features: 'pulsate' },
            { id: 'skin_013', name: 'Lavender Dream', icon: 'ðŸŸ£', price: 200, color: 0xe6e6fa, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.4, description: 'Light and airy, feels like floating.', features: 'transparency' },
            { id: 'skin_014', name: 'Cobalt Shell', icon: 'ðŸ”µ', price: 210, color: 0x0047ab, rarity: 'Uncommon', shape: 'box', multiplier: 1.4, description: 'A deep, protective shell.', features: 'none' },
            { id: 'skin_015', name: 'Cherry Bomb', icon: 'ðŸ’', price: 220, color: 0xde3163, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.4, description: 'Small, red, and surprisingly explosive on jumps.', features: 'none' },
            { id: 'skin_016', name: 'Rubber Tire', icon: 'âš«', price: 230, color: 0x333333, rarity: 'Uncommon', shape: 'box', multiplier: 1.4, description: 'Traction focused, excellent grip.', features: 'none' },
            { id: 'skin_017', name: 'Peppermint', icon: 'ðŸ¬', price: 240, color: 0xffeaea, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Sweet movement, cool design.', features: 'none' },
            { id: 'skin_018', name: 'Sunset Glow', icon: 'ðŸŒ…', price: 250, color: 0xfd5e53, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Warm colors for a comfortable run.', features: 'pulsate' },
            { id: 'skin_019', name: 'Deep Sea', icon: 'ðŸŒŠ', price: 260, color: 0x008b8b, rarity: 'Uncommon', shape: 'box', multiplier: 1.5, description: 'Drawn from the cold depths.', features: 'none' },
            { id: 'skin_020', name: 'Toxic Sludge', icon: 'ðŸ¤¢', price: 270, color: 0x7cfc00, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Wiggly and highly visible.', features: 'particles' },
            { id: 'skin_021', name: 'Brick Wall', icon: 'ðŸ§±', price: 280, color: 0xb22222, rarity: 'Uncommon', shape: 'box', multiplier: 1.5, description: 'Solid, dependable, and heavy.', features: 'none' },
            { id: 'skin_022', name: 'Sky High', icon: 'â˜ï¸', price: 290, color: 0x87ceeb, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'As light as air, watch the clouds go by.', features: 'transparency' },
            { id: 'skin_023', name: 'Copper Coin', icon: 'ðŸª™', price: 300, color: 0xb87333, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'A valuable basic.', features: 'none' },
            { id: 'skin_024', name: 'Jade Cube', icon: 'ðŸ”°', price: 300, color: 0x00a86b, rarity: 'Uncommon', shape: 'box', multiplier: 1.5, description: 'Hard stone, surprisingly fast.', features: 'none' },
            { id: 'skin_025', name: 'Grape Soda', icon: 'ðŸ‡', price: 300, color: 0x582c4f, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Fizzy and pops when you jump.', features: 'none' },
            { id: 'skin_026', name: 'Mars Rock', icon: 'ðŸª', price: 300, color: 0x996515, rarity: 'Uncommon', shape: 'box', multiplier: 1.5, description: 'Ancient Martian dirt.', features: 'none' },
            { id: 'skin_027', name: 'Plasma Green', icon: 'ðŸŸ¢', price: 300, color: 0x39ff14, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'A fizzing sphere of low-power energy.', features: 'pulsate' },
            { id: 'skin_028', name: 'Wet Cement', icon: 'ðŸ—ï¸', price: 300, color: 0x737373, rarity: 'Uncommon', shape: 'box', multiplier: 1.5, description: 'Sluggish look, swift movement.', features: 'none' },
            { id: 'skin_029', name: 'Frosted Glass', icon: 'ðŸ§Š', price: 300, color: 0xeeeeee, rarity: 'Uncommon', shape: 'sphere', multiplier: 1.5, description: 'Hard to see, but easy to move.', features: 'transparency' },

            // --- NEW RARE SKINS (x1.6 - x1.9, Price 500 - 1000) ---
            { id: 'skin_030', name: 'Fire Opal', icon: 'ðŸ”¥', price: 500, color: 0xff8c00, rarity: 'Rare', shape: 'sphere', multiplier: 1.6, description: 'Flickering inner core, slight warmth.', features: 'pulsate' },
            { id: 'skin_031', name: 'Amethyst Crystal', icon: 'ðŸ”®', price: 550, color: 0x9966cc, rarity: 'Rare', shape: 'box', multiplier: 1.6, description: 'Sharp edges, smooth flight.', features: 'none' },
            { id: 'skin_032', name: 'Ruby Core', icon: 'â™¦ï¸', price: 600, color: 0xe0115f, rarity: 'Rare', shape: 'sphere', multiplier: 1.6, description: 'A jewel of precision.', features: 'none' },
            { id: 'skin_033', name: 'Sapphire Box', icon: 'ðŸŸ¦', price: 650, color: 0x0f52ba, rarity: 'Rare', shape: 'box', multiplier: 1.7, description: 'Deep blue and strong, built for speed.', features: 'none' },
            { id: 'skin_034', name: 'Black Ice', icon: 'âš«', price: 700, color: 0x1f262a, rarity: 'Rare', shape: 'sphere', multiplier: 1.7, description: 'Slick and cold, very fast look.', features: 'transparency' },
            { id: 'skin_035', name: 'Titanium Shell', icon: 'ðŸ›¡ï¸', price: 750, color: 0x8899aa, rarity: 'Rare', shape: 'box', multiplier: 1.7, description: 'Hardened shell, slow to react, impossible to break.', features: 'pulsate' },
            { id: 'skin_036', name: 'Lava Flow', icon: 'ðŸŒ‹', price: 800, color: 0xcc472a, rarity: 'Rare', shape: 'sphere', multiplier: 1.7, description: 'Still molten, dangerous to touch.', features: 'pulsate' },
            { id: 'skin_037', name: 'Chrome Spike', icon: 'ðŸ’¿', price: 850, color: 0x808080, rarity: 'Rare', shape: 'box', multiplier: 1.7, description: 'Reflects the light perfectly.', features: 'none' },
            { id: 'skin_038', name: 'Rainbow Flicker', icon: 'ðŸŒˆ', price: 900, color: 0xff00ff, rarity: 'Rare', shape: 'sphere', multiplier: 1.8, description: 'Shifts colors constantly (visually just magenta).', features: 'pulsate' },
            { id: 'skin_039', name: 'Bubble Gum', icon: 'ðŸ«§', price: 950, color: 0xffc0cb, rarity: 'Rare', shape: 'sphere', multiplier: 1.8, description: 'Sticky and stretchy, great recovery.', features: 'transparency' },
            { id: 'skin_040', name: 'Neon Glitch', icon: 'ðŸ‘¾', price: 1000, color: 0x00ffcc, rarity: 'Rare', shape: 'box', multiplier: 1.8, description: 'Visual static, moves with an erratic precision.', features: 'particles' },
            { id: 'skin_041', name: 'Vaporwave', icon: 'ðŸŒ´', price: 1000, color: 0x800080, rarity: 'Rare', shape: 'sphere', multiplier: 1.8, description: 'A smooth purple, fueled by nostalgia.', features: 'none' },
            { id: 'skin_042', name: 'Crystal Skull', icon: 'ðŸ’€', price: 1100, color: 0xadd8e6, rarity: 'Rare', shape: 'box', multiplier: 1.8, description: 'Spooky but translucent.', features: 'transparency' },
            { id: 'skin_043', name: 'Crimson Tide', icon: 'ðŸ©¸', price: 1200, color: 0xdc143c, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'A powerful surge of red.', features: 'pulsate' },
            { id: 'skin_044', name: 'Jade Dragon', icon: 'ðŸ‰', price: 1300, color: 0x00a693, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'Ancient green stone of the east.', features: 'none' },
            { id: 'skin_045', name: 'Acid Rain', icon: 'ðŸŒ§ï¸', price: 1400, color: 0x8a2be2, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Purple and harmful, but very fast.', features: 'particles' },
            { id: 'skin_046', name: 'Molten Gold', icon: 'ðŸ‘‘', price: 1500, color: 0xffa812, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'Hotter than the standard Golden Orb.', features: 'pulsate' },
            { id: 'skin_047', name: 'Starlight', icon: 'â­', price: 1600, color: 0xfafad2, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'A faint, distant star.', features: 'particles' },
            { id: 'skin_048', name: 'Obsidian Slab', icon: 'âš«', price: 1700, color: 0x0c0c0c, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Darkest black, absorbs light.', features: 'none' },
            { id: 'skin_049', name: 'Coral Reef', icon: 'ðŸ ', price: 1800, color: 0xff7f50, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'Vibrant orange-pink from the warm waters.', features: 'none' },
            { id: 'skin_050', name: 'Radioactive', icon: 'â˜¢ï¸', price: 1900, color: 0xccff00, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Emits a faint, dangerous glow.', features: 'pulsate' },
            { id: 'skin_051', name: 'Emerald Gem', icon: 'ðŸŸ¢', price: 2000, color: 0x50c878, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'A highly valuable green jewel.', features: 'none' },
            { id: 'skin_052', name: 'Frostbite', icon: 'ðŸ¥¶', price: 2100, color: 0xa9f8ff, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Icy cold to the touch.', features: 'particles' },
            { id: 'skin_053', name: 'Galactic Core', icon: 'ðŸŒŒ', price: 2200, color: 0x3a2c4e, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'A miniature center of a galaxy.', features: 'pulsate' },
            { id: 'skin_054', name: 'Digital Rain', icon: 'ðŸ’¾', price: 2300, color: 0x00ff80, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Lines of code flow across the surface.', features: 'transparency' },
            { id: 'skin_055', name: 'Tidal Wave', icon: 'ðŸŒŠ', price: 2400, color: 0x00bfff, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'The power of the ocean surge.', features: 'none' },
            { id: 'skin_056', name: 'Iron Shard', icon: 'ðŸ”©', price: 2500, color: 0x43464b, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'Rough metal, high durability.', features: 'none' },
            { id: 'skin_057', name: 'Rose Gold', icon: 'ðŸŒ¸', price: 2600, color: 0xb76e79, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'Elegant and swift.', features: 'none' },
            { id: 'skin_058', name: 'Ghost Fire', icon: 'ðŸ•¯ï¸', price: 2700, color: 0xffe4b5, rarity: 'Rare', shape: 'sphere', multiplier: 1.9, description: 'A pale, ethereal flame.', features: 'transparency' },
            { id: 'skin_059', name: 'Abyss Depth', icon: 'âš«', price: 2800, color: 0x000033, rarity: 'Rare', shape: 'box', multiplier: 1.9, description: 'So dark it almost vanishes.', features: 'none' },

            // --- NEW EPIC SKINS (x2.0 - x2.5, Price 3000 - 5000) ---
            { id: 'skin_060', name: 'Arc Reactor', icon: 'â˜¢ï¸', price: 3000, color: 0x00ccff, rarity: 'Epic', shape: 'sphere', multiplier: 2.0, description: 'A contained fusion core. High energy.', features: 'pulsate' },
            { id: 'skin_061', name: 'Nebula Cloud', icon: 'ðŸ”­', price: 3200, color: 0x9370db, rarity: 'Epic', shape: 'sphere', multiplier: 2.0, description: 'A soft, drifting cosmic entity.', features: 'particles' },
            { id: 'skin_062', name: 'Hazard Tape', icon: 'âš ï¸', price: 3400, color: 0xffff00, rarity: 'Epic', shape: 'box', multiplier: 2.1, description: 'A highly visible warning sign.', features: 'none' },
            { id: 'skin_063', name: 'Plasma Cube', icon: 'ðŸŸ¢', price: 3600, color: 0x00ff00, rarity: 'Epic', shape: 'box', multiplier: 2.1, description: 'A perfect green plasma box, crackling with juice.', features: 'pulsate' },
            { id: 'skin_064', name: 'Shadow Step', icon: 'ðŸ‘Ÿ', price: 3800, color: 0x2f4f4f, rarity: 'Epic', shape: 'sphere', multiplier: 2.1, description: 'Moves without leaving a trace.', features: 'transparency' },
            { id: 'skin_065', name: 'Electric Storm', icon: 'â›ˆï¸', price: 4000, color: 0x483d8b, rarity: 'Epic', shape: 'sphere', multiplier: 2.2, description: 'Internal lightning flashes.', features: 'particles' },
            { id: 'skin_066', name: 'Magma Block', icon: 'ðŸ”¥', price: 4200, color: 0x8b0000, rarity: 'Epic', shape: 'box', multiplier: 2.2, description: 'Extremely hot and heavy-looking.', features: 'pulsate' },
            { id: 'skin_067', name: 'Cryo Freeze', icon: 'â„ï¸', price: 4400, color: 0x4682b4, rarity: 'Epic', shape: 'box', multiplier: 2.2, description: 'Made of supercooled blue liquid.', features: 'particles' },
            { id: 'skin_068', name: 'Phoenix Ash', icon: 'ðŸ¦', price: 4600, color: 0x5d5d5d, rarity: 'Epic', shape: 'sphere', multiplier: 2.3, description: 'The remains of a great flight, ready to rise.', features: 'none' },
            { id: 'skin_069', name: 'Hydro Vortex', icon: 'ðŸŒ€', price: 4800, color: 0x1e90ff, rarity: 'Epic', shape: 'sphere', multiplier: 2.3, description: 'A perpetual, contained water spiral.', features: 'transparency' },
            { id: 'skin_070', name: 'Chrome Plated', icon: 'ðŸ¤–', price: 5000, color: 0xcccccc, rarity: 'Epic', shape: 'box', multiplier: 2.3, description: 'Solid metal casing, reflective sheen.', features: 'none' },
            { id: 'skin_071', name: 'Crimson Ghost', icon: 'ðŸ‘»', price: 5200, color: 0xff4040, rarity: 'Epic', shape: 'sphere', multiplier: 2.3, description: 'A highly visible, transparent red phantom.', features: 'transparency' },
            { id: 'skin_072', name: 'Sandstorm', icon: 'ðŸŒªï¸', price: 5400, color: 0xf4a460, rarity: 'Epic', shape: 'sphere', multiplier: 2.4, description: 'A swirling mass of desert dust.', features: 'particles' },
            { id: 'skin_073', name: 'Circuit Board', icon: 'ðŸ”‹', price: 5600, color: 0x008080, rarity: 'Epic', shape: 'box', multiplier: 2.4, description: 'The inner workings of a high-speed processor.', features: 'pulsate' },
            { id: 'skin_074', name: 'Infinity Cube', icon: 'â™¾ï¸', price: 5800, color: 0x4b0082, rarity: 'Epic', shape: 'box', multiplier: 2.4, description: 'A seemingly endless block of deep indigo.', features: 'none' },
            { id: 'skin_075', name: 'Lunar Dust', icon: 'ðŸŒ•', price: 6000, color: 0xe0e0e0, rarity: 'Epic', shape: 'sphere', multiplier: 2.4, description: 'Pale white and weightless.', features: 'particles' },
            { id: 'skin_076', name: 'Black Hole', icon: 'âš«', price: 6200, color: 0x0a0a0a, rarity: 'Epic', shape: 'sphere', multiplier: 2.4, description: 'Absorbs all light, a true challenge to track.', features: 'none' },
            { id: 'skin_077', name: 'Cosmic Jelly', icon: 'ðŸª', price: 6400, color: 0xff66cc, rarity: 'Epic', shape: 'sphere', multiplier: 2.5, description: 'Bubbly pink cosmic goo.', features: 'transparency' },
            { id: 'skin_078', name: 'Aether Cube', icon: 'ðŸ’¨', price: 6600, color: 0x98fb98, rarity: 'Epic', shape: 'box', multiplier: 2.5, description: 'Floating green elemental air.', features: 'particles' },
            { id: 'skin_079', name: 'Bio-Luminescent', icon: 'ðŸ’¡', price: 6800, color: 0x33ff66, rarity: 'Epic', shape: 'sphere', multiplier: 2.5, description: 'Glows faintly in the dark.', features: 'pulsate' },
            { id: 'skin_080', name: 'Terra Cotta', icon: 'ðŸº', price: 7000, color: 0xcc7722, rarity: 'Epic', shape: 'box', multiplier: 2.5, description: 'Ancient clay, unbreakable.', features: 'none' },
            { id: 'skin_081', name: 'Northern Lights', icon: 'âœ¨', price: 7200, color: 0x4bcfa0, rarity: 'Epic', shape: 'sphere', multiplier: 2.5, description: 'A beautiful, shifting aurora.', features: 'transparency' },
            { id: 'skin_082', name: 'Iron Man Armor', icon: 'ðŸ¦¾', price: 7400, color: 0xcc0000, rarity: 'Epic', shape: 'box', multiplier: 2.5, description: 'Red and gold plate, built for flight.', features: 'pulsate' },
            { id: 'skin_083', name: 'Tesseract', icon: 'ðŸŒŒ', price: 7600, color: 0x00aaff, rarity: 'Epic', shape: 'box', multiplier: 2.5, description: 'A mysterious cosmic power source.', features: 'particles' },
            { id: 'skin_084', name: 'Midnight Violet', icon: 'ðŸŒ™', price: 7800, color: 0x551a8b, rarity: 'Epic', shape: 'sphere', multiplier: 2.5, description: 'A deep, mysterious violet sphere.', features: 'none' },
            
            // --- NEW LEGENDARY SKINS (x2.6 - x3.0, Price 10000 - 20000) ---
            { id: 'skin_085', name: 'Cthulhu\'s Eye', icon: 'ðŸ‘ï¸', price: 10000, color: 0x8a3324, rarity: 'Legendary', shape: 'sphere', multiplier: 2.6, description: 'A monstrous color, drives runners mad.', features: 'pulsate' },
            { id: 'skin_086', name: 'Frozen Comet', icon: 'â˜„ï¸', price: 11000, color: 0x7cfc00, rarity: 'Legendary', shape: 'box', multiplier: 2.6, description: 'Trail of icy particles follows every move.', features: 'particles' },
            { id: 'skin_087', name: 'Eternity Stone', icon: 'ðŸ•°ï¸', price: 12000, color: 0x9c27b0, rarity: 'Legendary', shape: 'box', multiplier: 2.7, description: 'Imbued with the power of time itself.', features: 'none' },
            { id: 'skin_088', name: 'Dimensional Tear', icon: 'âš«', price: 13000, color: 0x000000, rarity: 'Legendary', shape: 'sphere', multiplier: 2.7, description: 'A gap in reality, almost fully invisible.', features: 'transparency' },
            { id: 'skin_089', name: 'King Midas', icon: 'ðŸ†', price: 14000, color: 0xffd700, rarity: 'Legendary', shape: 'box', multiplier: 2.8, description: 'Everything it touches turns to gold.', features: 'pulsate' },
            { id: 'skin_090', name: 'Solar Flare', icon: 'â˜€ï¸', price: 15000, color: 0xff4500, rarity: 'Legendary', shape: 'sphere', multiplier: 2.8, description: 'Burning hot. Watch your steps; gravity may fear you.', features: 'particles' },
            { id: 'skin_091', name: 'Cybernetic Wisp', icon: 'ðŸ’¡', price: 16000, color: 0x00eeff, rarity: 'Legendary', shape: 'sphere', multiplier: 2.8, description: 'A highly advanced, digitized light source.', features: 'pulsate' },
            { id: 'skin_092', name: 'Phoenix Core', icon: 'ðŸ”¥', price: 17000, color: 0xffa500, rarity: 'Legendary', shape: 'box', multiplier: 2.9, description: 'The burning heart of the mythical bird.', features: 'particles' },
            { id: 'skin_093', name: 'Atlantean Orb', icon: 'ðŸ”±', price: 18000, color: 0x4169e1, rarity: 'Legendary', shape: 'sphere', multiplier: 2.9, description: 'The lost artifact of the sunken city.', features: 'transparency' },
            { id: 'skin_094', name: 'Red Dragon Scale', icon: 'ðŸ²', price: 19000, color: 0x8b0000, rarity: 'Legendary', shape: 'box', multiplier: 2.9, description: 'Toughest material known to man.', features: 'pulsate' },
            { id: 'skin_095', name: 'Zeus\' Bolt', icon: 'âš¡', price: 20000, color: 0xffff33, rarity: 'Legendary', shape: 'sphere', multiplier: 3.0, description: 'Raw lightning harnessed into a sphere.', features: 'particles' },
            { id: 'skin_096', name: 'Odin\'s Rune', icon: 'ðŸ§ ', price: 20000, color: 0x999999, rarity: 'Legendary', shape: 'box', multiplier: 3.0, description: 'A box of perfect wisdom and speed.', features: 'none' },
            { id: 'skin_097', name: 'Valkyrie Wing', icon: 'ðŸ˜‡', price: 21000, color: 0xeeeeff, rarity: 'Legendary', shape: 'sphere', multiplier: 3.0, description: 'Soft, white, feather-like momentum.', features: 'transparency' },
            { id: 'skin_098', name: 'Hypercube', icon: 'ðŸ“¦', price: 22000, color: 0x0000ff, rarity: 'Legendary', shape: 'box', multiplier: 3.0, description: 'A four-dimensional shape.', features: 'pulsate' },
            { id: 'skin_099', name: 'Master Clockwork', icon: 'âš™ï¸', price: 23000, color: 0x8b4513, rarity: 'Legendary', shape: 'sphere', multiplier: 3.0, description: 'Perfectly engineered mechanism.', features: 'none' },

            // --- NEW MYTHIC SKINS (x3.1 - x4.0, Price 50000 - 100000) ---
            { id: 'skin_100', name: 'Celestial Shard', icon: 'ðŸŒŸ', price: 50000, color: 0xffcc00, rarity: 'Mythic', shape: 'box', multiplier: 3.1, description: 'A piece of a newborn star.', features: 'particles' },
            { id: 'skin_101', name: 'Primal Chaos', icon: 'ðŸ’¥', price: 60000, color: 0xff0000, rarity: 'Mythic', shape: 'sphere', multiplier: 3.3, description: 'Unstable, pure, and absolutely untamable energy.', features: 'pulsate' },
            { id: 'skin_102', name: 'Infinite Void', icon: 'âš«', price: 75000, color: 0x110033, rarity: 'Mythic', shape: 'box', multiplier: 3.5, description: 'Contains a pocket dimension of nothingness.', features: 'transparency' },
            { id: 'skin_103', name: 'The Creator', icon: 'ðŸŽ¨', price: 90000, color: 0xffffff, rarity: 'Mythic', shape: 'sphere', multiplier: 3.7, description: 'The white canvas upon which all levels are painted.', features: 'particles' },
            { id: 'skin_104', name: 'Omni-Paradox', icon: 'â™¾ï¸', price: 100000, color: 0x00ffcc, rarity: 'Mythic', shape: 'box', multiplier: 4.0, description: 'Pure chaotic energy. The ultimate grind reward.', features: 'transparency' }
        ];

        // --- SKIN STATE VARIABLES ---
        let purchasedSkins = ['skin_001']; // Starter skin is always owned
        let currentSkinId = 'skin_001';
        let pulsationTime = 0;
        // Particle system variables
        let playerParticleSystem = null;
        const PARTICLE_COUNT = 100;
        let particleVelocities = []; // Stores velocity vectors for each particle
        const PARTICLE_LIFETIME = 120; // Max frame count for particle life
        let particleAges = []; // Current age of each particle
        // --------------------------
        
        // --- JUMP BUFFERING VARIABLES ---
        const JUMP_BUFFER_DURATION = 8; 
        let jumpBufferTimer = 0; 
        // ---------------------------------

        // New control and state variables
        let isPaused = true;
        let isTransitioning = false; 
        const sensitivity = 0.002; 

        // Global variables for Firebase compliance (not used in this self-contained game)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // End compliance variables

        // --- Audio Variables ---
        let jumpSynth;
        let winSynth;
        let deathSynth; 
        let bgmSynth;   
        let audioInitialized = false;

        // --- Core Functions ---

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); 

            // Camera setup
            const container = document.getElementById('game-container');
            const aspect = container.clientWidth / container.clientHeight;
            camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Lighting 
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0); 
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5); 
            directionalLight.position.set(50, 100, 50).normalize(); 
            scene.add(directionalLight);

            createPlayer(); 
            generateNewLevel(); 
            updateCoinDisplay(); 

            updateCamera();

            // --- Control and Pointer Lock Setup ---
            document.addEventListener('pointerlockchange', lockChangeAlert, false);
            document.addEventListener('pointerlockerror', (e) => console.error("PointerLock Error:", e), false);
            document.addEventListener('mousemove', onMouseMove, false);
            
            // Click on the game screen to lock the pointer and start the game
            renderer.domElement.addEventListener('click', async () => {
                await startAudio(); 
                initAudio(); 
                
                if (isPaused && !isTransitioning && document.getElementById('shop-modal').classList.contains('hidden')) {
                    renderer.domElement.requestPointerLock();
                }
            }, false);

            window.addEventListener('keydown', onKeyDown, false);
            window.addEventListener('keyup', onKeyUp, false);
            window.addEventListener('resize', onWindowResize, false);

            // --- Shop Event Listeners ---
            document.getElementById('open-shop-btn').addEventListener('click', toggleShop);
            document.getElementById('close-shop-btn').addEventListener('click', toggleShop);
        }
        
        /**
         * Updates the coin display in the top right corner.
         */
        function updateCoinDisplay() {
            document.getElementById('coin-display').textContent = `ðŸ’° ${coinCount}`;
        }

        // Function to start audio context (must be called on user interaction)
        async function startAudio() {
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                } catch (e) {
                    console.error("Tone.js context failed to start:", e);
                }
            }
        }

        function initAudio() {
            if (audioInitialized) return;

            jumpSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" }, 
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.1 },
                volume: -10 
            }).toDestination();

            winSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 8,
                envelope: { attack: 0.001, decay: 0.5, sustain: 0.01, release: 0.5 },
                volume: -5 
            }).toDestination();
            
            deathSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.0, release: 0.1 },
                volume: -8
            }).chain(new Tone.Filter(300, 'lowpass').toDestination());

            const bassSynth = new Tone.MonoSynth({
                oscillator: { type: "square" },
                envelope: { attack: 0.05, decay: 0.1, sustain: 0.1, release: 0.2 },
                volume: -27 
            }).toDestination();

            const pulseSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 },
                volume: -23 
            }).toDestination();
            
            const kickSynth = new Tone.MembraneSynth({
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.001, release: 0.6 },
                octaves: 10,
                volume: -10 
            }).toDestination();

            const snareSynth = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0.0, release: 0.05 },
                volume: -15 
            }).toDestination();

            bgmSynth = { bass: bassSynth, pulse: pulseSynth, kick: kickSynth, snare: snareSynth }; 
            startMusicLoop(); 
            audioInitialized = true;
        }

        function startMusicLoop() {
            if (!bgmSynth || !bgmSynth.bass) return;

            Tone.Transport.bpm.value = 140; 

            const drumSequence = new Tone.Sequence((time, step) => {
                if (step === 0 || step === 4) { bgmSynth.kick.triggerAttackRelease("C1", "8n", time); }
                if (step === 2 || step === 6) { bgmSynth.snare.triggerAttackRelease("8n", time); }
            }, [0, 1, 2, 3, 4, 5, 6, 7], "8n"); 

            drumSequence.loop = true;
            drumSequence.start(0);

            const harmonyProgression = ["C2", "G2", "A2", "E2", "F2", "C2", "F2", "G2"]; 
            const harmonySequence = new Tone.Sequence((time, note) => {
                bgmSynth.bass.triggerAttackRelease(note, "1m", time);
            }, harmonyProgression, "1m"); 

            harmonySequence.loop = true;
            harmonySequence.start(0);

            const patternA = [
                ["0:0:0", "C4"], ["0:0:1", "E4"], ["0:0:2", "G4"], ["0:0:3", "C5"],
                ["0:1:0", "B4"], ["0:1:1", "G4"], ["0:1:2", "E4"], ["0:1:3", "C4"],
                ["0:2:0", "E4"], ["0:2:1", "G4"], ["0:2:2", "C5"], ["0:2:3", "G4"],
                ["0:3:0", "E4"], ["0:3:1", "C4"], ["0:3:2", "G3"], ["0:3:3", "E3"]
            ];
            const patternB = [
                ["0:0:0", "G4"], ["0:0:2", "A4"], 
                ["0:1:2", "G4"], 
                ["0:2:0", "F4"], ["0:2:2", "G4"],
                ["0:3:0", "E4"]
            ];
            const patternC = [
                ["0:0:0", "G4"], ["0:1:0", "F4"], ["0:2:0", "E4"], ["0:3:0", "C4"] 
            ];

            const melodySequence = new Tone.Sequence((time, patternIndex) => {
                let pattern;
                let noteDuration = "16n"; 
                
                switch(patternIndex) {
                    case 0: pattern = patternA; noteDuration = "16n"; break; 
                    case 1: pattern = patternB; noteDuration = "8n"; break;  
                    case 2: pattern = patternA; noteDuration = "16n"; break; 
                    case 3: pattern = patternC; noteDuration = "1m"; break;  
                }
                
                const phrase = new Tone.Part((t, note) => {
                    let duration = (patternIndex === 3) ? "3n" : noteDuration;
                    
                    if (patternIndex === 3) {
                         bgmSynth.pulse.triggerAttackRelease(note, "3n", t); 
                    } else {
                         bgmSynth.pulse.triggerAttackRelease(note, duration, t);
                    }
                    
                }, pattern);

                phrase.start(time); 
                phrase.stop(time + '1m'); 

            }, [0, 1, 2, 3], "4m"); 

            melodySequence.loop = true;
            melodySequence.start(0);

            Tone.Transport.start();
        }

        function playJumpSound() {
            if (!audioInitialized) return;
            jumpSynth.triggerAttackRelease("C4", "8n");
        }

        function playWinSound() {
            if (!audioInitialized) return;
            const now = Tone.now();
            const chord = ["C5", "E5", "G5", "C6"];
            chord.forEach((note, index) => {
                winSynth.triggerAttackRelease(note, "8n", now + index * 0.05);
            });
        }
        
        function playDeathSound() {
             if (!audioInitialized) return;
             deathSynth.triggerAttack();
             deathSynth.triggerRelease(Tone.now() + 0.3);
        }

        function executeJump() {
            if (player.isGrounded && !isPaused && !isTransitioning) {
                playerVelocity.y = jumpPower;
                player.isGrounded = false;
                playJumpSound();
            }
        }

        function createPlayer() {
            player = new THREE.Group();
            scene.add(player);
            
            // Player's bounding body is a fixed sphere regardless of skin appearance
            player.userData.yOffsetToFeet = PLAYER_RADIUS; 
            player.isGrounded = false;

            // Initialize the player with the default skin
            updatePlayerSkin(getSkinDetails(currentSkinId));
        }

        /**
         * Cleans up the old skin mesh and particle system and applies the new skin.
         */
        function updatePlayerSkin(skinDetails) {
            // 1. Clean up old mesh and particles
            if (playerMesh) {
                player.remove(playerMesh);
                playerMesh.geometry.dispose();
                if (playerMesh.material.length) {
                    playerMesh.material.forEach(m => m.dispose());
                } else {
                    playerMesh.material.dispose();
                }
                playerMesh = null;
            }
            if (playerParticleSystem) {
                scene.remove(playerParticleSystem);
                playerParticleSystem.geometry.dispose();
                playerParticleSystem.material.dispose();
                playerParticleSystem = null;
            }
            
            // 2. Create New Mesh (Geometry and Material)
            let geometry;
            if (skinDetails.shape === 'box') {
                 geometry = new THREE.BoxGeometry(PLAYER_SCALE * 2, PLAYER_SCALE * 2, PLAYER_SCALE * 2); 
            } else {
                 geometry = new THREE.SphereGeometry(PLAYER_SCALE, 32, 16); 
            }
            
            let material;
            if (skinDetails.features === 'pulsate') {
                // Pulsate: Start with a basic Lambert material with emissive properties
                material = new THREE.MeshLambertMaterial({ color: skinDetails.color, emissive: skinDetails.color, emissiveIntensity: 0.1 });
            } else if (skinDetails.features === 'transparency') {
                // Transparency: Transparent and slightly darker color
                material = new THREE.MeshLambertMaterial({ 
                    color: skinDetails.color, 
                    transparent: true, 
                    opacity: 0.6,
                    emissive: skinDetails.color,
                    emissiveIntensity: 0.05 
                });
            } else {
                // Basic Runner / Aqua Prism / Particles: Standard
                material = new THREE.MeshLambertMaterial({ color: skinDetails.color }); 
            }

            playerMesh = new THREE.Mesh(geometry, material);
            playerMesh.position.y = 0; // Relative to the player group's pivot point
            player.add(playerMesh);
            
            // 3. Create Particle System 
            if (skinDetails.features === 'particles') {
                 initParticles(skinDetails.color);
            }
        }
        
        /**
         * Initializes a particle system attached to the player.
         */
        function initParticles(color) {
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            const ages = new Float32Array(PARTICLE_COUNT);
            particleVelocities = [];
            particleAges = [];
            
            const pGeometry = new THREE.BufferGeometry();
            pGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3).setUsage(THREE.DynamicDrawUsage));
            pGeometry.setAttribute('age', new THREE.BufferAttribute(ages, 1).setUsage(THREE.DynamicDrawUsage));

            const pMaterial = new THREE.PointsMaterial({
                color: color,
                size: 0.05,
                blending: THREE.AdditiveBlending,
                transparent: true,
                depthWrite: false, // Prevents Z-fighting with player mesh
                opacity: 0.5
            });

            playerParticleSystem = new THREE.Points(pGeometry, pMaterial);
            scene.add(playerParticleSystem);

            // Initialize all particles to be hidden and assign random velocities
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                positions[i * 3 + 0] = 0; // X
                positions[i * 3 + 1] = -100; // Y (hidden)
                positions[i * 3 + 2] = 0; // Z
                
                particleVelocities.push(new THREE.Vector3(
                    THREE.MathUtils.randFloat(-0.01, 0.01), // Small random horizontal velocity
                    THREE.MathUtils.randFloat(0.01, 0.03),  // Consistent upward velocity
                    THREE.MathUtils.randFloat(-0.01, 0.01)
                ));
                particleAges.push(PARTICLE_LIFETIME); // Start with max age so they are initially hidden
            }
            pGeometry.attributes.position.needsUpdate = true;
        }

        /**
         * Updates the position and state of the particles.
         */
        function updateParticles() {
            if (!playerParticleSystem || !playerMesh || isPaused) return;

            const positions = playerParticleSystem.geometry.attributes.position.array;
            const ages = playerParticleSystem.geometry.attributes.age.array;
            
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const age = particleAges[i];

                if (age >= PARTICLE_LIFETIME) {
                    // Particle died, reset it to player position (spawn new particle)
                    const spawnOffset = 0.05;
                    positions[i * 3 + 0] = player.position.x + THREE.MathUtils.randFloat(-spawnOffset, spawnOffset);
                    positions[i * 3 + 1] = player.position.y - PLAYER_RADIUS; // Spawn at the bottom of the player
                    positions[i * 3 + 2] = player.position.z + THREE.MathUtils.randFloat(-spawnOffset, spawnOffset);
                    
                    particleAges[i] = 0;
                    // Reset opacity for the new particle
                    playerParticleSystem.geometry.attributes.age.setX(i, 0);

                } else {
                    // Update position
                    const velocity = particleVelocities[i];
                    positions[i * 3 + 0] += velocity.x;
                    positions[i * 3 + 1] += velocity.y;
                    positions[i * 3 + 2] += velocity.z;

                    // Update age
                    particleAges[i]++;
                    
                    // Update the 'age' attribute to control shader effects (like fade)
                    playerParticleSystem.geometry.attributes.age.setX(i, age / PARTICLE_LIFETIME);
                }
            }

            playerParticleSystem.geometry.attributes.position.needsUpdate = true;
            playerParticleSystem.geometry.attributes.age.needsUpdate = true;
        }


        /**
         * Creates a flag mesh (pole + fabric) for the finish line.
         */
        function createFinishFlag(position) {
            const flagGroup = new THREE.Group();
            const poleGeometry = new THREE.CylinderGeometry(0.1, 0.1, 5, 8); 
            const poleMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff }); 
            const pole = new THREE.Mesh(poleGeometry, poleMaterial);
            pole.position.y = 2.5; 
            flagGroup.add(pole);

            const flagGeometry = new THREE.PlaneGeometry(2, 1.5); 
            const flagMaterial = new THREE.MeshLambertMaterial({ color: 0xffff00, side: THREE.DoubleSide }); 
            const flag = new THREE.Mesh(flagGeometry, flagMaterial);
            
            flag.position.set(1.0, 4.0, 0); 
            flagGroup.add(flag);

            flagGroup.position.copy(position);
            return flagGroup;
        }

        /**
         * Clears the current level and generates a new, random parkour course.
         */
        function generateNewLevel() {
            levelCounter++;
            document.getElementById('level-display').textContent = `Level ${levelCounter}`;

            // 1. Clear existing platforms, finish line, and flag
            for (const platform of platforms) {
                scene.remove(platform);
                platform.geometry.dispose();
                platform.material.dispose();
            }
            platforms = [];
            if (finishLine) {
                scene.remove(finishLine);
                finishLine.geometry.dispose();
                finishLine.material.dispose();
                finishLine = null;
            }
            if (finishFlag) { 
                scene.remove(finishFlag);
                finishFlag = null; 
            }
            
            // 2. Set constants for generation
            const PLATFORM_COUNT = 5 + levelCounter * 2; 
            let currentPlatform = null;
            const MAIN_PLATFORM_COLOR = 0x228B22; // Dark Green 
            
            // Start Platform 
            currentPlatform = addPlatform(0, 0, 0, 10, 1, 10, MAIN_PLATFORM_COLOR); 

            // 3. Generate path
            for (let i = 0; i < PLATFORM_COUNT; i++) {
                const lastY = currentPlatform.position.y;
                const lastH = currentPlatform.geometry.parameters.height;
                
                const stepX = THREE.MathUtils.randFloat(3.0 + Math.min(levelCounter * 0.1, 1.5), 4.5);
                const heightDiff = THREE.MathUtils.randFloat(-2.0, 1.5);

                const newW = THREE.MathUtils.randFloat(2.0, 4); 
                const newH = THREE.MathUtils.randFloat(0.5, 1);
                const newD = THREE.MathUtils.randFloat(2.0, 4); 

                let newY = lastY + lastH / 2 + newH / 2 + heightDiff;
                newY = Math.max(0.5, newY); 
                
                const newX = currentPlatform.position.x + stepX;
                const newZ = currentPlatform.position.z + THREE.MathUtils.randFloat(-4.0, 4.0);
                
                currentPlatform = addPlatform(newX, newY, newZ, newW, newH, newD, MAIN_PLATFORM_COLOR);
            }
            
            // 4. Place Finish Line
            finishLine = addPlatform(
                currentPlatform.position.x, 
                currentPlatform.position.y + currentPlatform.geometry.parameters.height / 2 + 0.25, 
                currentPlatform.position.z, 
                5, 0.5, 5, MAIN_PLATFORM_COLOR 
            );
            finishLine.userData.isFinish = true;
            
            // 5. Add the flag
            finishFlag = createFinishFlag(new THREE.Vector3(
                finishLine.position.x,
                finishLine.position.y + finishLine.geometry.parameters.height / 2, 
                finishLine.position.z
            ));
            scene.add(finishFlag);


            // 6. Reset player
            resetPlayer();

            // 7. Update message box if game is running
            if (!isPaused && levelCounter > 1) {
                showMessageBox(`Level ${levelCounter} Generated!`, "New course loaded. Get ready for a challenge!", false, true);
            }
        }

        function addPlatform(x, y, z, w, h, d, color) {
            const geometry = new THREE.BoxGeometry(w, h, d);
            const material = new THREE.MeshLambertMaterial({ color: color });
            const platform = new THREE.Mesh(geometry, material);
            platform.position.set(x, y, z);
            scene.add(platform);
            platforms.push(platform);
            platform.userData.boundingBox = new THREE.Box3().setFromObject(platform);
            return platform;
        }

        // --- Shop Functions ---

        function getSkinDetails(id) {
            return SKINS.find(s => s.id === id);
        }

        /**
         * Toggles the shop modal open and closed.
         */
        function toggleShop() {
            const modal = document.getElementById('shop-modal');
            const isShopOpen = !modal.classList.contains('hidden');
            
            if (isShopOpen) {
                // CLOSING shop
                modal.classList.add('hidden');
                
                // UX Improvement: Automatically request pointer lock to resume game
                renderer.domElement.requestPointerLock();
                
                if (audioInitialized) Tone.Transport.start(); 
            } else {
                // OPENING shop
                modal.classList.remove('hidden');
                isPaused = true;
                
                // Exit pointer lock if active
                if (document.pointerLockElement === renderer.domElement) {
                    document.exitPointerLock(); 
                }
                
                renderShopContent();
                if (audioInitialized) Tone.Transport.pause();
            }
        }
        
        function renderShopContent() {
            const container = document.getElementById('skin-list-container');
            container.innerHTML = '';
            
            SKINS.forEach(skin => {
                const isOwned = purchasedSkins.includes(skin.id);
                const isEquipped = currentSkinId === skin.id;
                
                const card = document.createElement('div');
                card.className = `skin-card ${isEquipped ? 'selected' : ''}`;
                card.id = `skin-card-${skin.id}`;
                
                let buttonHTML;

                if (isEquipped) {
                    buttonHTML = '<div class="equipped-label">EQUIPPED</div>';
                } else if (isOwned) {
                    buttonHTML = `<button class="buy-button" onclick="selectSkin('${skin.id}')" style="background-color: #00ff7f;">EQUIP</button>`;
                } else {
                    buttonHTML = `<button class="buy-button" onclick="buySkin('${skin.id}', event)">BUY ðŸ’° ${skin.price}</button>`;
                }
                
                if (isOwned && !isEquipped) {
                     card.style.cursor = 'pointer';
                     card.onclick = () => selectSkin(skin.id);
                }

                const skinColorHex = `#${skin.color.toString(16).padStart(6, '0')}`;

                card.innerHTML = `
                    <div class="skin-rarity rarity-${skin.rarity}">${skin.rarity.toUpperCase()}</div>
                    <div class="skin-icon" style="color:${skinColorHex};">${skin.icon}</div>
                    <div class="skin-name">${skin.name}</div>
                    <div class="skin-desc">${skin.description}</div>
                    <div class="skin-multiplier">Reward Multiplier: x${skin.multiplier.toFixed(1)}</div>
                    ${buttonHTML}
                `;
                
                container.appendChild(card);
            });
        }

        function buySkin(skinId, event) {
            event.stopPropagation();
            const skin = getSkinDetails(skinId);
            
            if (coinCount >= skin.price) {
                coinCount -= skin.price;
                purchasedSkins.push(skinId);
                updateCoinDisplay();
                selectSkin(skinId); 
                
                showMessageBox("Purchase Successful!", `${skin.name} purchased and equipped! Coins left: ðŸ’° ${coinCount}`, false, true);
                renderShopContent(); 
            } else {
                showMessageBox("Not Enough Coins", `You need ðŸ’° ${skin.price} for the ${skin.name}. You only have ðŸ’° ${coinCount}.`, false, true);
            }
        }

        function selectSkin(skinId) {
            if (!purchasedSkins.includes(skinId) || currentSkinId === skinId) return;

            // Remove selected class from previous card
            const oldCard = document.getElementById(`skin-card-${currentSkinId}`);
            if (oldCard) oldCard.classList.remove('selected');
            
            // Set new skin
            currentSkinId = skinId;
            updatePlayerSkin(getSkinDetails(skinId));
            
            // Add selected class to new card and re-render button states
            renderShopContent(); 
        }
        
        // --- Event Handlers ---

        function onWindowResize() {
            const container = document.getElementById('game-container');
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;

            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        }

        // Handles mouse movement for camera/player rotation
        function onMouseMove(event) {
            if (isPaused) return;
            const rotationDeltaX = event.movementX * sensitivity;
            player.rotation.y -= rotationDeltaX; 
        }

        // Toggles pause state based on pointer lock status
        function lockChangeAlert() {
            if (document.pointerLockElement === renderer.domElement) {
                // Pointer Locked: Game is running
                if (document.getElementById('shop-modal').classList.contains('hidden')) {
                     isPaused = false;
                     // Explicitly hide the message box on successful lock
                     document.getElementById('message-box').classList.add('hidden'); 
                } else {
                    document.exitPointerLock(); 
                }
            } else {
                // Pointer Unlocked: Game is paused
                isPaused = true;
                
                const box = document.getElementById('message-box');
                const titleElement = box.querySelector('.message-title');
                
                const isFinalMessage = titleElement.textContent.includes("COMPLETE") || titleElement.textContent.includes("Ready");
                
                // Only show the Click to Resume message if not currently displaying a win/loss/shop message
                if (!isFinalMessage && document.getElementById('shop-modal').classList.contains('hidden')) {
                   showMessageBox("Game Paused", "Press ESC to resume or click anywhere on the game screen.", false, false);
                }
            }
        }

        function showMessageBox(title, subtitle, isFinish, autoHide = false) {
            const box = document.getElementById('message-box');
            const titleElement = box.querySelector('.message-title');
            
            titleElement.textContent = title;
            box.querySelector('.message-subtitle').textContent = subtitle;

            if (isFinish) {
                titleElement.classList.add('win-color');
            } else {
                titleElement.classList.remove('win-color');
            }

            box.classList.remove('hidden');

            if (autoHide) {
                 setTimeout(() => {
                    if (!isPaused && box.textContent.includes(title)) { 
                        box.classList.add('hidden');
                    }
                 }, 3000); 
            }
        }

        function onKeyDown(event) {
            keys[event.code] = true;
            
            if (event.code === 'KeyE' && !isTransitioning) {
                toggleShop();
                return;
            }

            if (event.code === 'Space' && !isPaused && !isTransitioning) {
                jumpBufferTimer = JUMP_BUFFER_DURATION;

                if (player.isGrounded) {
                    executeJump();
                    jumpBufferTimer = 0; 
                }
            }
            if (event.code === 'Escape' && !isTransitioning) {
                 if (!document.getElementById('shop-modal').classList.contains('hidden')) {
                     toggleShop();
                     return;
                 }
                 
                 if (document.pointerLockElement === renderer.domElement) {
                    document.exitPointerLock(); 
                 } else if (isPaused) {
                    renderer.domElement.requestPointerLock();
                 }
            }
        }

        function onKeyUp(event) {
            keys[event.code] = false;
        }

        // --- Game Loop Functions ---

        function handleMovement() {
            if (isPaused) return; 

            if (jumpBufferTimer > 0) {
                jumpBufferTimer--;
            }

            let forward = 0;
            let right = 0;
            
            if (keys['KeyW']) { forward = 1; }
            if (keys['KeyS']) { forward = -1; }
            if (keys['KeyA']) { right = -1; }
            if (keys['KeyD']) { right = 1; }

            if (forward !== 0 || right !== 0) {
                let direction = new THREE.Vector3(right, 0, -forward); 
                const playerAngle = player.rotation.y;
                direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), playerAngle);
                
                direction.normalize().multiplyScalar(moveSpeed);

                player.position.x += direction.x;
                player.position.z += direction.z;
            }

            // Apply Gravity
            if (!player.isGrounded) {
                playerVelocity.y -= GRAVITY;
            }

            // Apply Y velocity
            player.position.y += playerVelocity.y;

            // Check for falling off the world
            if (player.position.y < -10) {
                playDeathSound(); 
                resetPlayer();
            }

            checkCollision();
        }

        function checkCollision() {
            player.isGrounded = false;
            // The bounding box check uses the player group's position which is at the center of the visible skin
            const playerBox = new THREE.Box3().setFromObject(player); 

            for (const platform of platforms) {
                const platformBox = platform.userData.boundingBox;
                if (playerBox.intersectsBox(platformBox)) {

                    const yOffsetToFeet = player.userData.yOffsetToFeet; 
                    const playerBottom = player.position.y - yOffsetToFeet;
                    const platformTop = platform.position.y + platform.geometry.parameters.height / 2;
                    const platformDepth = platform.geometry.parameters.depth;

                    if (playerVelocity.y <= 0 && playerBottom < platformTop + 0.03) { 
                        
                        const platformWidth = platform.geometry.parameters.width;

                        const onX = Math.abs(player.position.x - platform.position.x) < (platformWidth / 2) + PLAYER_RADIUS;
                        const onZ = Math.abs(player.position.z - platform.position.z) < (platformDepth / 2) + PLAYER_RADIUS;

                        if (onX && onZ) {
                            
                            if (playerBottom < platformTop) {
                                player.position.y = platformTop + yOffsetToFeet; 
                            }

                            playerVelocity.y = 0;
                            player.isGrounded = true;
                            
                            if (jumpBufferTimer > 0) {
                                executeJump();
                                jumpBufferTimer = 0; 
                            }


                            // Check for finish line
                            if (platform.userData.isFinish) {
                                
                                if (isTransitioning) return; 
                                isTransitioning = true; 
                                
                                // 1. Calculate Reward, applying the skin multiplier
                                const skinDetails = getSkinDetails(currentSkinId);
                                const currentMultiplier = skinDetails ? skinDetails.multiplier : 1.0; 
                                const actualReward = Math.round(LEVEL_REWARD * currentMultiplier);

                                isPaused = true;
                                document.exitPointerLock(); 
                                
                                playWinSound(); 
                                
                                // 2. Update Coins
                                coinCount += actualReward;
                                const winMessage = `LEVEL ${levelCounter} COMPLETE! (+${actualReward} Coins)`;
                                updateCoinDisplay(); 

                                // 3. Display Win/Generate Next Level
                                showMessageBox(winMessage, `Course finished. Generating Level ${levelCounter + 1}...`, true, false); 
                                
                                setTimeout(() => {
                                    generateNewLevel();
                                    
                                    if (isPaused && document.getElementById('shop-modal').classList.contains('hidden')) {
                                        // Auto-resume camera lock after transition
                                        renderer.domElement.requestPointerLock();
                                        showMessageBox(`Level ${levelCounter} Ready!`, "Good luck!", true, true);
                                    }
                                    
                                    isTransitioning = false; 
                                }, 2000);
                                return;
                            }
                            return; 
                        }
                    } 
                }
            }
        }

        function updateCamera() {
            const localOffset = new THREE.Vector3(0, 3, 5); 
            const rotation = player.quaternion.clone();
            localOffset.applyQuaternion(rotation);

            const cameraPosition = new THREE.Vector3().copy(player.position).add(localOffset);
            camera.position.copy(cameraPosition);

            camera.lookAt(player.position);
        }

        function resetPlayer() {
            const PLATFORM_Y = 0.5;
            const Y_OFFSET_TO_FEET = player.userData.yOffsetToFeet; 

            player.position.set(0, PLATFORM_Y + Y_OFFSET_TO_FEET, 0);
            playerVelocity.set(0, 0, 0);
            player.isGrounded = true;
        }

        function handleSkinFeatures(time) {
            const skinDetails = getSkinDetails(currentSkinId);

            if (skinDetails.features === 'pulsate' && playerMesh && playerMesh.material) {
                // Pulsating light
                pulsationTime += 0.05;
                const intensity = 0.1 + (Math.sin(pulsationTime) * 0.05); // Range from 0.05 to 0.15
                playerMesh.material.emissiveIntensity = intensity;
            }

            if (skinDetails.features === 'transparency' && playerMesh && playerMesh.material) {
                // Void Ghost: Subtle color shift
                const hueShift = Math.sin(time * 0.001) * 0.05 + 0.5; // Shift hue around the color base
                const color = skinDetails.color;
                
                // Temporarily create a color object to manipulate hue
                const c = new THREE.Color(color);
                c.setHSL(c.getHSL(new THREE.HSL()).h + hueShift % 1, 0.6, 0.7); 
                playerMesh.material.color.setHex(color); // Keep base color for most of the effect
                playerMesh.material.emissive.setHex(c.getHex()); // Make the emissive color shift slightly
            }
            
            if (skinDetails.features === 'particles') {
                updateParticles();
            }
        }

        function animate(time) {
            requestAnimationFrame(animate);
            
            if (finishFlag) {
                finishFlag.rotation.y += 0.02; 
            }
            
            handleSkinFeatures(time);

            if (!isPaused) {
                handleMovement();
                updateCamera();
            }

            renderer.render(scene, camera);
        }

        // --- Initialization ---
        window.onload = function () {
            init();
            animate(0); // Pass initial time
        };

    </script>
</body>
</html>